<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Motorista - Sistema de Corridas</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  body { 
    margin:0; 
    font-family: Arial, sans-serif; 
    background:#f4f4f4; 
  }
  .container { 
    width:100%; 
    max-width:500px; 
    margin:auto; 
    padding:20px; 
  }
  .login-section {
    background: white;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 15px;
  }
  input, button { 
    width:100%; 
    padding:10px; 
    margin:8px 0; 
    border-radius:4px; 
    border:1px solid #bbb; 
    box-sizing: border-box;
  }
  button { 
    background:#007bff; 
    color:white; 
    border:none; 
    cursor: pointer;
  }
  button:hover { 
    background:#0056b3; 
  }
  .botoes-superiores {
    display: flex;
    gap: 10px;
    margin: 15px 0;
  }
  .botoes-superiores button {
    flex: 1;
    padding: 12px;
  }
  #btnSelecionar { background: #28a745; }
  #btnSelecionar:hover { background: #218838; }
  #btnDefinirLocal { background: #17a2b8; }
  #btnDefinirLocal:hover { background: #138496; }
  #btnBuscar { background: #ffc107; color: black; }
  #btnBuscar:hover { background: #e0a800; }
  #btnTerminar { background: #dc3545; }
  #btnTerminar:hover { background: #c82333; }
  
  #listaPassageiros {
    background: white;
    border-radius: 8px;
    padding: 15px;
    margin: 15px 0;
    max-height: 300px;
    overflow-y: auto;
  }
  .btn-passageiro {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    color: #495057;
    padding: 12px;
    margin: 8px 0;
    text-align: left;
    border-radius: 6px;
    cursor: pointer;
    width: 100%;
  }
  .btn-passageiro:hover {
    background: #e9ecef;
    border-color: #007bff;
  }
  
  #map { 
    width:100%; 
    height:70vh; 
    background:#eee;
    border-radius: 8px;
    margin-top: 15px;
  }
  #msg { 
    text-align:center; 
    color:red; 
    margin: 10px 0;
  }
  .local-input {
    background: white;
    padding: 15px;
    border-radius: 8px;
    margin: 10px 0;
  }
</style>
</head>
<body>

<div class="container">
  <!-- Login -->
  <div class="login-section">
    <h2 style="text-align:center; margin-bottom:20px;">Login Motorista</h2>
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="senha" placeholder="Senha">
    <button id="btnLogin">Entrar</button>
    <p id="msg"></p>
  </div>

  <!-- Bot√µes Superiores -->
  <div class="botoes-superiores">
    <button id="btnSelecionar">üë• Selecionar Passageiro</button>
    <button id="btnDefinirLocal">üìç Definir Local</button>
    <button id="btnBuscar">üó∫Ô∏è Buscar Passageiro</button>
    <button id="btnTerminar">üèÅ Terminar Corrida</button>
  </div>

  <!-- Input para definir local -->
  <div class="local-input">
    <input type="text" id="enderecoMotorista" placeholder="Digite seu endere√ßo atual">
  </div>

  <!-- Lista de Passageiros -->
  <div id="listaPassageiros" style="display:none;"></div>

  <!-- Mapa -->
  <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const API = "https://moveme-backend-v80p.onrender.com";
let map;
let motoristaLogado = null;
let corridaSelecionada = null;
let localMotorista = null;

// ---- LOGIN MOTORISTA ----
document.getElementById("btnLogin").onclick = async () => {
  const email = document.getElementById("email").value.trim();
  const senha = document.getElementById("senha").value.trim();
  const msg = document.getElementById("msg");

  msg.textContent = "";

  try {
    const res = await fetch(`${API}/motora`);
    const dados = await res.json();

    const motorista = dados.find(x => x.email === email && x.senha === senha);

    if (!motorista) {
      msg.textContent = "Login inv√°lido";
      return;
    }

    motoristaLogado = motorista;
    msg.style.color = "green";
    msg.textContent = "Logado com sucesso";

  } catch (e) {
    msg.textContent = "Erro de conex√£o";
  }
};

// ---- SELECIONAR PASSAGEIRO ----
document.getElementById("btnSelecionar").onclick = async () => {
  if (!motoristaLogado) {
    alert("Fa√ßa login primeiro");
    return;
  }

  try {
    const res = await fetch(`${API}/corridas/status/esperando%20motorista`);
    const corridas = await res.json();
    
    const listaDiv = document.getElementById("listaPassageiros");
    listaDiv.style.display = 'block';
    listaDiv.innerHTML = '<h3>Passageiros Dispon√≠veis:</h3>';
    
    if (corridas.length === 0) {
      listaDiv.innerHTML += '<p>Nenhum passageiro dispon√≠vel</p>';
      return;
    }

    for (const corrida of corridas) {
      const endereco = await converterLatLngParaEndereco(corrida.origem_lat, corrida.origem_lng);
      const btn = document.createElement('button');
      btn.className = 'btn-passageiro';
      btn.innerHTML = `‚úÖ ${corrida.passageiro_nome} - ${endereco} - ID:${corrida.id}`;
      btn.onclick = () => selecionarCorrida(corrida);
      listaDiv.appendChild(btn);
    }

  } catch (e) {
    alert("Erro ao carregar passageiros");
  }
};

// ---- DEFINIR LOCAL ----
document.getElementById("btnDefinirLocal").onclick = async () => {
  const endereco = document.getElementById('enderecoMotorista').value.trim();
  if (!endereco) {
    alert("Digite seu endere√ßo atual");
    return;
  }

  try {
    localMotorista = await converterEnderecoParaLatLng(endereco);
    alert(`Local definido: ${endereco}`);
  } catch (e) {
    alert("Erro ao converter endere√ßo");
  }
};

// ---- BUSCAR PASSAGEIRO ----
document.getElementById("btnBuscar").onclick = () => {
  if (!motoristaLogado || !corridaSelecionada || !localMotorista) {
    alert("Selecione um passageiro e defina seu local primeiro");
    return;
  }

  carregarMapaComRota();
};

// ---- TERMINAR CORRIDA ----
document.getElementById("btnTerminar").onclick = () => {
  if (!motoristaLogado || !corridaSelecionada) {
    alert("Nenhuma corrida em andamento");
    return;
  }

  // Redireciona para a p√°gina de execu√ß√£o da corrida
  window.location.href = `mapadomotora.html?corrida_id=${corridaSelecionada.id}&motorista_id=${motoristaLogado.id}`;
};

// ---- FUN√á√ïES AUXILIARES ----
async function converterLatLngParaEndereco(lat, lng) {
  try {
    const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
    const data = await response.json();
    
    if (data.address) {
      const addr = data.address;
      return `${addr.road || ''} ${addr.house_number || ''}, ${addr.suburb || addr.neighbourhood || ''}/${addr.state || ''}`.trim();
    }
    return "Endere√ßo n√£o encontrado";
  } catch (e) {
    return "Erro ao buscar endere√ßo";
  }
}

async function converterEnderecoParaLatLng(endereco) {
  try {
    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(endereco)}`);
    const data = await response.json();
    
    if (data && data[0]) {
      return {
        lat: parseFloat(data[0].lat),
        lng: parseFloat(data[0].lon)
      };
    }
    throw new Error("Endere√ßo n√£o encontrado");
  } catch (e) {
    throw new Error("Erro ao converter endere√ßo");
  }
}

async function selecionarCorrida(corrida) {
  try {
    await fetch(`${API}/corridas/${corrida.id}/status`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        status: 'em andamento',
        motorista_id: motoristaLogado.id,
        motorista_nome: motoristaLogado.nome
      })
    });

    corridaSelecionada = corrida;
    document.getElementById('listaPassageiros').style.display = 'none';
    alert(`Corrida ${corrida.id} selecionada!`);
    
  } catch (e) {
    alert("Erro ao selecionar corrida");
  }
}

function carregarMapaComRota() {
  if (map) {
    map.remove();
  }

  const centerLat = (localMotorista.lat + corridaSelecionada.origem_lat) / 2;
  const centerLng = (localMotorista.lng + corridaSelecionada.origem_lng) / 2;
  
  map = L.map('map').setView([centerLat, centerLng], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

  L.marker([localMotorista.lat, localMotorista.lng])
    .addTo(map)
    .bindPopup(`<b>${motoristaLogado.nome}</b><br>Motorista`)
    .openPopup();

  L.marker([corridaSelecionada.origem_lat, corridaSelecionada.origem_lng])
    .addTo(map)
    .bindPopup(`<b>${corridaSelecionada.passageiro_nome}</b><br>Passageiro`);

  const rota = [
    [localMotorista.lat, localMotorista.lng],
    [corridaSelecionada.origem_lat, corridaSelecionada.origem_lng]
  ];
  
  L.polyline(rota, {color: 'blue'}).addTo(map);
}
</script>
</body>
</html>
