<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Login Motorista</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  body { 
    margin:0; 
    font-family: Arial, sans-serif; 
    background:#f4f4f4; 
  }
  .container { 
    width:100%; 
    max-width:500px; 
    margin:auto; 
    padding:20px; 
  }
  .login-section {
    background: white;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 15px;
  }
  input, button { 
    width:100%; 
    padding:10px; 
    margin:8px 0; 
    border-radius:4px; 
    border:1px solid #bbb; 
    box-sizing: border-box;
  }
  button { 
    background:#007bff; 
    color:white; 
    border:none; 
    cursor: pointer;
  }
  button:hover { 
    background:#0056b3; 
  }
  .botoes-corrida {
    display: flex;
    gap: 10px;
    margin: 15px 0;
  }
  .botoes-corrida button {
    flex: 1;
    padding: 12px;
  }
  #btnCorridasDisponiveis { background: #28a745; }
  #btnCorridasDisponiveis:hover { background: #218838; }
  #btnTerminar { background: #dc3545; }
  #btnTerminar:hover { background: #c82333; }
  #btnPagar { background: #ffc107; color: black; }
  #btnPagar:hover { background: #e0a800; }
  
  #map { 
    width:100%; 
    height:70vh; 
    background:#eee;
    border-radius: 8px;
  }
  #msg { 
    text-align:center; 
    color:red; 
    margin: 10px 0;
  }
  .corrida-item {
    background: white;
    padding: 15px;
    margin: 10px 0;
    border-radius: 8px;
    border-left: 4px solid #007bff;
  }
  .modal {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
  }
  .modal-content {
    background: white;
    margin: 5% auto;
    padding: 20px;
    width: 90%;
    max-width: 400px;
    border-radius: 8px;
    max-height: 80vh;
    overflow-y: auto;
  }
</style>
</head>
<body>

<div class="container">
  <!-- Login -->
  <div class="login-section">
    <h2 style="text-align:center; margin-bottom:20px;">Login Motorista</h2>
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="senha" placeholder="Senha">
    <button id="btnLogin">Entrar</button>
    <p id="msg"></p>
  </div>

  <!-- Bot√µes LADO A LADO ACIMA DO MAPA -->
  <div class="botoes-corrida">
    <button id="btnCorridasDisponiveis">Corridas Dispon√≠veis</button>
    <button id="btnTerminar">Terminar Corrida</button>
    <button id="btnPagar">Pagar Corrida</button>
  </div>

  <!-- MAPA GRANDE -->
  <div id="map"></div>
</div>

<!-- Modal Corridas Dispon√≠veis -->
<div id="modalCorridas" class="modal">
  <div class="modal-content">
    <h3>Corridas Dispon√≠veis</h3>
    <div id="listaCorridas"></div>
    <button onclick="fecharModal()" style="margin-top: 15px; background:#6c757d;">Fechar</button>
  </div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const API = "https://moveme-backend-v80p.onrender.com";
let map, window.motorista, window.corridaAtual;

// ---- LOGIN MOTORISTA ----
document.getElementById("btnLogin").onclick = async () => {
  const email = document.getElementById("email").value.trim();
  const senha = document.getElementById("senha").value.trim();
  const msg = document.getElementById("msg");

  msg.textContent = "";

  try {
    const res = await fetch(`${API}/motora`);
    const dados = await res.json();

    const m = dados.find(x => x.email === email && x.senha === senha);

    if (!m) {
      msg.textContent = "Login inv√°lido";
      return;
    }

    window.motorista = m;
    msg.style.color = "green";
    msg.textContent = "Logado com sucesso";

    carregarMapa(m);
    carregarMinhasCorridas(m.id);

  } catch (e) {
    msg.textContent = "Erro de conex√£o";
  }
};

// ---- MAPA COM LEAFLET ----
function carregarMapa(motorista) {
  const lat = motorista.latitude || -15.7975;
  const lng = motorista.longitude || -47.8919;
  
  map = L.map('map').setView([lat, lng], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

  L.marker([lat, lng])
    .addTo(map)
    .bindPopup(`<b>${motorista.nome}</b><br>Motorista`)
    .openPopup();
}

// ---- CORRIDAS DISPON√çVEIS ----
document.getElementById("btnCorridasDisponiveis").onclick = async () => {
  if (!window.motorista) {
    alert("Fa√ßa login primeiro");
    return;
  }
  
  try {
    const res = await fetch(`${API}/corridas/disponiveis`);
    const corridas = await res.json();
    
    const lista = document.getElementById("listaCorridas");
    lista.innerHTML = "";
    
    if (corridas.length === 0) {
      lista.innerHTML = "<p>Nenhuma corrida dispon√≠vel</p>";
    } else {
      corridas.forEach(corrida => {
        const item = document.createElement("div");
        item.className = "corrida-item";
        item.innerHTML = `
          <p><strong>Passageiro:</strong> ${corrida.passageiro_nome}</p>
          <p><strong>Valor:</strong> R$ ${corrida.valor}</p>
          <p><strong>Pagamento:</strong> ${corrida.modo_pagamento}</p>
          <button onclick="aceitarCorrida(${corrida.id})" style="background:#28a745; margin-top:8px;">Aceitar Corrida</button>
        `;
        lista.appendChild(item);
      });
    }
    
    document.getElementById("modalCorridas").style.display = "block";
  } catch (e) {
    alert("Erro ao carregar corridas");
  }
};

// ---- ACEITAR CORRIDA ----
async function aceitarCorrida(corridaId) {
  try {
    const res = await fetch(`${API}/corridas/aceitar/${corridaId}`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        motorista_id: window.motorista.id,
        motorista_nome: window.motorista.nome
      })
    });

    if (res.ok) {
      alert("Corrida aceita com sucesso!");
      fecharModal();
      carregarMinhasCorridas(window.motorista.id);
    } else {
      alert("Erro ao aceitar corrida");
    }
  } catch (e) {
    alert("Erro de conex√£o");
  }
}

// ---- MINHAS CORRIDAS ----
async function carregarMinhasCorridas(idMotorista) {
  try {
    const res = await fetch(`${API}/corridas`);
    const corridas = await res.json();
    window.corridaAtual = corridas.find(c => c.motorista_id == idMotorista && c.status === 'andamento');
    
    if (window.corridaAtual) {
      console.log("Corrida em andamento:", window.corridaAtual);
    }
  } catch (e) {
    console.log("Erro ao carregar corridas");
  }
}

// ---- BOT√ïES ----
document.getElementById("btnTerminar").onclick = async () => {
  if (!window.corridaAtual) {
    alert("Nenhuma corrida ativa.");
    return;
  }
  
  try {
    const res = await fetch(`${API}/corridas/terminar/${window.corridaAtual.id}`, {
      method: 'POST'
    });
    
    if (res.ok) {
      alert("Corrida terminada!");
      window.corridaAtual = null;
    }
  } catch (e) {
    alert("Erro ao terminar corrida");
  }
};

document.getElementById("btnPagar").onclick = async () => {
  if (!window.corridaAtual) {
    alert("Nenhuma corrida ativa.");
    return;
  }
  
  try {
    const res = await fetch(`${API}/corridas/pago/${window.corridaAtual.id}`, {
      method: 'POST'
    });
    
    if (res.ok) {
      alert("Corrida marcada como paga!");
    }
  } catch (e) {
    alert("Erro ao pagar corrida");
  }
};

function fecharModal() {
  document.getElementById("modalCorridas").style.display = "none";
}
</script>

<script>
const API = "https://moveme-backend-v80p.onrender.com";

document.getElementById("btnLogin").onclick = async function() {
  const email = document.getElementById("email").value.trim();
  const senha = document.getElementById("senha").value.trim();
  const msg = document.getElementById("msg");

  msg.textContent = "Verificando login...";
  msg.style.color = "blue";

  try {
    const response = await fetch(API + "/motora");
    const motoristas = await response.json();
    
    console.log("Motoristas no banco:", motoristas);

    const motorista = motoristas.find(m => m.email === email && m.senha === senha);

    if (motorista) {
      // ‚úÖ LOGIN BEM-SUCEDIDO
      msg.innerHTML = `‚úÖ <b>Logado com sucesso!</b><br>Motorista: ${motorista.nome}<br>Placa: ${motorista.placa}`;
      msg.style.color = "green";
      
      window.motoristaLogado = motorista;
      carregarMapa(motorista);
      habilitarBotoes();
      
    } else {
      // ‚ùå LOGIN FALHOU
      msg.innerHTML = `‚ùå <b>Login falhou!</b><br>Verifique email e senha<br>Motoristas no sistema: ${motoristas.length}`;
      msg.style.color = "red";
      
      // Mostra mapa mesmo com falha
      carregarMapa({nome: "N√£o logado", latitude: -15.7975, longitude: -47.8919});
    }

  } catch (error) {
    msg.innerHTML = `‚ö†Ô∏è <b>Erro de conex√£o</b><br>${error.message}`;
    msg.style.color = "orange";
  }
};

function carregarMapa(motorista) {
  const lat = motorista.latitude || -15.7975;
  const lng = motorista.longitude || -47.8919;
  
  if (window.map) window.map.remove();
  
  window.map = L.map('map').setView([lat, lng], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(window.map);

  const marker = L.marker([lat, lng]).addTo(window.map);
  
  if (motorista.email) {
    // Motorista logado
    marker.bindPopup(`
      <b>üöó ${motorista.nome}</b><br>
      üìß ${motorista.email}<br>
      üè∑Ô∏è ${motorista.placa}<br>
      ‚úÖ <span style="color:green">LOGADO</span>
    `).openPopup();
  } else {
    // N√£o logado
    marker.bindPopup(`<b>‚ö†Ô∏è N√£o logado</b><br>Fa√ßa login primeiro`).openPopup();
  }
}

function habilitarBotoes() {
  // Habilita os bot√µes de corrida ap√≥s login
  document.querySelectorAll('.botoes-corrida button').forEach(btn => {
    btn.style.opacity = "1";
    btn.disabled = false;
  });
}
</script>


  
</body>
</html>
