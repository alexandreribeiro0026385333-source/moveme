<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Motorista - Sistema de Corridas</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  body { 
    margin:0; 
    font-family: Arial, sans-serif; 
    background:#f4f4f4; 
  }
  .container { 
    width:100%; 
    max-width:500px; 
    margin:auto; 
    padding:20px; 
  }
  .login-section, .form-section {
    background: white;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 15px;
  }
  input, button { 
    width:100%; 
    padding:10px; 
    margin:8px 0; 
    border-radius:4px; 
    border:1px solid #bbb; 
    box-sizing: border-box;
  }
  button { 
    background:#007bff; 
    color:white; 
    border:none; 
    cursor: pointer;
  }
  button:hover { 
    background:#0056b3; 
  }
  .botoes-superiores {
    display: flex;
    gap: 10px;
    margin: 15px 0;
  }
  .botoes-superiores button {
    flex: 1;
    padding: 12px;
  }
  #btnSelecionar { background: #28a745; }
  #btnDefinirLocal { background: #17a2b8; }
  #btnBuscar { background: #ffc107; color: black; }
  #btnTerminar { background: #dc3545; }
  #btnChat { background: #6f42c1; }
  
  #listaPassageiros {
    background: white;
    border-radius: 8px;
    padding: 15px;
    margin: 15px 0;
    max-height: 300px;
    overflow-y: auto;
  }
  .passageiro-item {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    color: #495057;
    padding: 12px;
    margin: 8px 0;
    text-align: left;
    border-radius: 6px;
    width: 100%;
    cursor: pointer;
  }
  .passageiro-item:hover {
    background: #e9ecef;
  }
  
  #map { 
    width:100%; 
    height:70vh; 
    background:#eee;
    border-radius: 8px;
    margin-top: 15px;
  }
  #msg { 
    text-align:center; 
    color:red; 
    margin: 10px 0;
  }
  .logo {
    text-align: center;
    color: red;
    font-size: 24px;
    font-weight: bold;
    margin-bottom: 20px;
  }
  .user-info {
    background: #e9ecef;
    padding: 10px;
    border-radius: 6px;
    margin: 10px 0;
    text-align: center;
  }
</style>
</head>
<body>

<div class="container">
  <!-- Logo -->
  <div class="logo">MOVEME</div>

  <!-- Login -->
  <div class="login-section">
    <h2 style="text-align:center; margin-bottom:20px;">Login Motorista</h2>
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="senha" placeholder="Senha">
    <button onclick="fazerLogin()">Entrar</button>
    <p id="msg"></p>
  </div>

  <!-- Informa√ß√µes do Usu√°rio -->
  <div class="user-info" id="userInfo" style="display:none;">
    <h3 id="saudacao"></h3>
    <p><strong>ID:</strong> <span id="userId"></span></p>
    <p><strong>Email:</strong> <span id="userEmail"></span></p>
  </div>

  <!-- Bot√µes Superiores -->
  <div class="botoes-superiores">
    <button onclick="carregarPassageiros()" id="btnSelecionar">üë• Selecionar</button>
    <button onclick="definirLocal()" id="btnDefinirLocal">üìç Definir Local</button>
    <button onclick="buscarPassageiro()" id="btnBuscar">üó∫Ô∏è Buscar</button>
    <button onclick="abrirChat()" id="btnChat">üí¨ Chat</button>
    <button onclick="terminarCorrida()" id="btnTerminar">üèÅ Chegou</button>
  </div>

  <!-- Input para definir local -->
  <div class="form-section">
    <input type="text" id="enderecoMotorista" placeholder="Digite seu endere√ßo atual">
  </div>

  <!-- Lista de Passageiros -->
  <div id="listaPassageiros" style="display:none;"></div>

  <!-- Formul√°rio Sele√ß√£o Manual -->
  <div class="form-section" id="formSelecionar" style="display:none;">
    <h3>Selecionar Passageiro:</h3>
    <input type="text" id="idCorrida" placeholder="ID da Corrida">
    <button onclick="aceitarCorrida()">‚úÖ Aceitar Corrida</button>
  </div>

  <!-- Mapa -->
  <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// Vari√°veis globais
const API = "https://moveme-backend-v80p.onrender.com";
let map;
let motoristaLogado = null;
let corridaSelecionada = null;
let localMotorista = null;

// ---- FUN√á√ÉO 1: LOGIN ----
function fazerLogin() {
  const email = document.getElementById("email").value;
  const senha = document.getElementById("senha").value;
  const msg = document.getElementById("msg");

  msg.innerHTML = "";

  if (!email || !senha) {
    msg.innerHTML = "Digite email e senha";
    return;
  }

  fetch(API + "/motora")
    .then(res => res.json())
    .then(dados => {
      const motorista = dados.find(x => x.email === email && x.senha === senha);
      
      if (!motorista) {
        msg.innerHTML = "Login inv√°lido";
        return;
      }

      motoristaLogado = motorista;
      msg.style.color = "green";
      msg.innerHTML = "Logado com sucesso";
      
      // Mostrar informa√ß√µes do usu√°rio
      mostrarInfoUsuario(motorista);
    })
    .catch(e => {
      msg.innerHTML = "Erro de conex√£o";
    });
}

// ---- MOSTRAR INFORMA√á√ïES DO USU√ÅRIO ----
function mostrarInfoUsuario(motorista) {
  const userInfo = document.getElementById("userInfo");
  const saudacao = document.getElementById("saudacao");
  const userId = document.getElementById("userId");
  const userEmail = document.getElementById("userEmail");
  
  // Pega primeiro nome
  const firstName = motorista.nome.split(' ')[0];
  
  saudacao.innerHTML = "üëã Ol√°, " + firstName + "!";
  userId.innerHTML = motorista.id;
  userEmail.innerHTML = motorista.email;
  
  userInfo.style.display = 'block';
}

// ---- FUN√á√ÉO 2: CARREGAR PASSAGEIROS ----
function carregarPassageiros() {
  if (!motoristaLogado) {
    alert("Fa√ßa login primeiro");
    return;
  }

  fetch(API + "/corridas/status/esperando%20motorista")
    .then(res => res.json())
    .then(corridas => {
      const listaDiv = document.getElementById("listaPassageiros");
      const formDiv = document.getElementById("formSelecionar");
      
      listaDiv.style.display = 'block';
      formDiv.style.display = 'block';
      listaDiv.innerHTML = '<h3>Passageiros Dispon√≠veis (Clique para copiar ID):</h3>';
      
      if (corridas.length === 0) {
        listaDiv.innerHTML += '<p>Nenhum passageiro dispon√≠vel</p>';
        return;
      }

      corridas.forEach(corrida => {
        converterLatLngParaEndereco(corrida.origem_lat, corrida.origem_lng)
          .then(endereco => {
            const div = document.createElement('div');
            div.className = 'passageiro-item';
            div.innerHTML = `‚úÖ <strong>${corrida.passageiro_nome}</strong> - ${endereco} - <strong>ID:${corrida.id}</strong>`;
            div.onclick = function() {
              document.getElementById('idCorrida').value = corrida.id;
            };
            listaDiv.appendChild(div);
          });
      });
    })
    .catch(e => {
      alert("Erro ao carregar passageiros");
    });
}

// ---- FUN√á√ÉO 3: ACEITAR CORRIDA ----
function aceitarCorrida() {
  const idCorrida = document.getElementById("idCorrida").value;
  
  if (!idCorrida) {
    alert("Digite o ID da corrida");
    return;
  }

  if (!motoristaLogado) {
    alert("Fa√ßa login primeiro");
    return;
  }

  fetch(API + "/corridas/" + idCorrida + "/aceitar", {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      motorista_id: motoristaLogado.id,
      motorista_nome: motoristaLogado.nome
    })
  })
  .then(res => res.json())
  .then(data => {
    alert("‚úÖ Corrida aceita com sucesso!");
    document.getElementById('listaPassageiros').style.display = 'none';
    document.getElementById('formSelecionar').style.display = 'none';
    
    // Busca dados da corrida para usar depois
    fetch(API + "/corridas")
      .then(res => res.json())
      .then(corridas => {
        corridaSelecionada = corridas.find(c => c.id == idCorrida);
      });
  })
  .catch(err => {
    alert("‚ùå Erro ao aceitar corrida");
  });
}

// ---- FUN√á√ÉO 4: DEFINIR LOCAL ----
function definirLocal() {
  const endereco = document.getElementById('enderecoMotorista').value;
  
  if (!endereco) {
    alert("Digite seu endere√ßo atual");
    return;
  }

  converterEnderecoParaLatLng(endereco)
    .then(coords => {
      localMotorista = coords;
      alert("Local definido: " + endereco);
    })
    .catch(e => {
      alert("Erro ao converter endere√ßo");
    });
}

// ---- FUN√á√ÉO 5: BUSCAR PASSAGEIRO ----
function buscarPassageiro() {
  if (!motoristaLogado || !corridaSelecionada || !localMotorista) {
    alert("Selecione um passageiro e defina seu local primeiro");
    return;
  }

  carregarMapaComRota();
}

// ---- FUN√á√ÉO 6: ABRIR CHAT ----
function abrirChat() {
  if (!motoristaLogado) {
    alert("Fa√ßa login primeiro");
    return;
  }

  if (!corridaSelecionada) {
    alert("Selecione uma corrida primeiro");
    return;
  }

  // Abre chat em nova janela/p√°gina
  const chatUrl = `chat.html?corrida_id=${corridaSelecionada.id}&user_type=motorista&user_id=${motoristaLogado.id}`;
  window.open(chatUrl, '_blank');
}

// ---- FUN√á√ÉO 7: TERMINAR CORRIDA ----
function terminarCorrida() {
  if (!motoristaLogado || !corridaSelecionada) {
    alert("Nenhuma corrida em andamento");
    return;
  }

  // Passa ID do motorista para a pr√≥xima p√°gina
  window.location.href = "mapadomotora.html?corrida_id=" + corridaSelecionada.id + "&motorista_id=" + motoristaLogado.id;
}

// ---- FUN√á√ïES AUXILIARES ----
function converterLatLngParaEndereco(lat, lng) {
  return fetch("https://nominatim.openstreetmap.org/reverse?format=json&lat=" + lat + "&lon=" + lng)
    .then(res => res.json())
    .then(data => {
      if (data.address) {
        const addr = data.address;
        return (addr.road || '') + ' ' + (addr.house_number || '') + ', ' + (addr.suburb || addr.neighbourhood || '') + '/' + (addr.state || '');
      }
      return "Endere√ßo n√£o encontrado";
    })
    .catch(e => {
      return "Erro ao buscar endere√ßo";
    });
}

function converterEnderecoParaLatLng(endereco) {
  return fetch("https://nominatim.openstreetmap.org/search?format=json&q=" + encodeURIComponent(endereco))
    .then(res => res.json())
    .then(data => {
      if (data && data[0]) {
        return {
          lat: parseFloat(data[0].lat),
          lng: parseFloat(data[0].lon)
        };
      }
      throw new Error("Endere√ßo n√£o encontrado");
    });
}

function carregarMapaComRota() {
  if (map) {
    map.remove();
  }

  const centerLat = (localMotorista.lat + corridaSelecionada.origem_lat) / 2;
  const centerLng = (localMotorista.lng + corridaSelecionada.origem_lng) / 2;
  
  map = L.map('map').setView([centerLat, centerLng], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

  L.marker([localMotorista.lat, localMotorista.lng])
    .addTo(map)
    .bindPopup("<b>" + motoristaLogado.nome + "</b><br>Motorista")
    .openPopup();

  L.marker([corridaSelecionada.origem_lat, corridaSelecionada.origem_lng])
    .addTo(map)
    .bindPopup("<b>" + corridaSelecionada.passageiro_nome + "</b><br>Passageiro");

  const rota = [
    [localMotorista.lat, localMotorista.lng],
    [corridaSelecionada.origem_lat, corridaSelecionada.origem_lng]
  ];
  
  L.polyline(rota, {color: 'blue'}).addTo(map);
}
</script>
</body>
</html>
