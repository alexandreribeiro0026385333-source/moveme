<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Acompanhar Corrida - MOVEME</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
<style>
  body { margin:0; font-family: Arial, sans-serif; background:#f4f4f4; }
  .container { width:100%; max-width:500px; margin:auto; padding:20px; }
  .login-section, .corrida-section { background: white; padding: 20px; border-radius: 8px; margin-bottom: 15px; }
  input, button { width:100%; padding:10px; margin:8px 0; border-radius:4px; border:1px solid #bbb; box-sizing: border-box; }
  button { cursor: pointer; border:none; }
  #map { width:100%; height:70vh; background:#eee; border-radius: 8px; margin:10px 0; }
  .status { padding: 10px; border-radius: 4px; margin: 5px 0; }
  .processando { background: #fff3cd; color: #856404; }
  .sucesso { background: #d1edff; color: #155724; }
  .erro { background: #f8d7da; color: #721c24; }
  .info { background: #e9ecef; padding: 15px; border-radius: 8px; margin: 10px 0; }
  .header { background: #dc3545; color: white; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px; }
  .user-info { background: #f8f9fa; padding: 10px; border-radius: 8px; margin: 10px 0; text-align: center; }
</style>
</head>
<body>

<div class="container">
  <!-- Header MOVEME -->
  <div class="header">
    <h1 style="margin:0;">ğŸš— MOVEME</h1>
    <p style="margin:5px 0 0 0; font-size:14px;">Sua corrida segura e rÃ¡pida</p>
  </div>

  <!-- Login -->
  <div class="login-section">
    <h2 style="text-align:center; margin-bottom:20px;">Acompanhar Corrida</h2>
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="senha" placeholder="Senha">
    <button onclick="fazerLogin()" style="background:#007bff; color:white;">ğŸ”‘ Fazer Login</button>
    <div id="msg"></div>
  </div>

  <!-- Corrida -->
  <div id="corridaSection" class="corrida-section" style="display:none;">
    <!-- InformaÃ§Ãµes do UsuÃ¡rio -->
    <div id="userInfo" class="user-info" style="display:none;">
      <h3 id="saudacao" style="margin:0;">OlÃ¡, UsuÃ¡rio!</h3>
      <p id="userEmail" style="margin:5px 0 0 0; font-size:12px; color:#666;"></p>
    </div>

    <h3 style="text-align:center;">Sua Corrida</h3>
    
    <!-- InformaÃ§Ãµes da Corrida -->
    <div class="info">
      <p><strong>ğŸ’° Valor:</strong> <span id="infoValor">R$ 0,00</span></p>
      <p><strong>ğŸ“ Origem:</strong> <span id="infoOrigem">-</span></p>
      <p><strong>ğŸ¯ Destino:</strong> <span id="infoDestino">-</span></p>
      <p><strong>ğŸš— Status:</strong> <span id="infoStatus">-</span></p>
      <p><strong>ğŸ‘¤ Motorista:</strong> <span id="infoMotorista">-</span></p>
    </div>

    <!-- BOTÃƒO 1: Buscar Corrida -->
    <button onclick="buscarCorrida()" style="background:#17a2b8; color:white;">ğŸ” Buscar Minha Corrida</button>
    <div id="statusBuscar"></div>

    <!-- BOTÃƒO 2: Verificar Motorista -->
    <button onclick="verificarMotorista()" style="background:#6f42c1; color:white;">ğŸ‘¥ Verificar Motorista</button>
    <div id="statusMotorista"></div>

    <!-- BOTÃƒO 3: Carregar Mapa -->
    <button onclick="carregarMapa()" style="background:#28a745; color:white;">ğŸ—ºï¸ Carregar Mapa com Rota</button>
    <div id="statusMapa"></div>

    <!-- BOTÃƒO 4: Atualizar Status -->
    <button onclick="atualizarStatus()" style="background:#ffc107; color:black;">ğŸ”„ Atualizar para "Esperando Motorista"</button>
    <div id="statusAtualizar"></div>

    <!-- BOTÃƒO 5: Chat -->
    <button onclick="abrirChat()" style="background:#20c997; color:white;">ğŸ’¬ Abrir Chat com Motorista</button>
    <div id="statusChat"></div>

    <!-- Mapa (Aumentado verticalmente) -->
    <div id="map"></div>
  </div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
<script>
// ---- VARIÃVEIS GLOBAIS ----
const API = "https://moveme-backend-v80p.onrender.com";
let passageiro = null, mapa = null, corridaAtual = null;
let executando = false;

// ---- VERIFICAR ID NA URL ----
function verificarIdUrl() {
  const urlParams = new URLSearchParams(window.location.search);
  const id = urlParams.get('id');
  
  if (id) {
    document.getElementById('email').value = `usuario${id}@email.com`;
    document.getElementById('senha').value = 'senha123';
    document.getElementById('msg').innerHTML = '<div class="status processando">ID detectado na URL. Clique em Fazer Login.</div>';
  }
}

// ---- BOTÃƒO 1: LOGIN ----
async function fazerLogin() {
  if (executando) return;
  executando = true;
  
  const email = document.getElementById("email").value.trim();
  const senha = document.getElementById("senha").value.trim();
  const msg = document.getElementById("msg");

  if (!email || !senha) {
    mostrarStatus(msg, "âŒ Digite email e senha", "erro");
    executando = false;
    return;
  }

  mostrarStatus(msg, "ğŸŸ¡ Verificando login...", "processando");

  try {
    const res = await fetch(`${API}/bonecos`);
    const dados = await res.json();
    const p = dados.find(x => x.email === email && x.senha === senha);

    if (!p) {
      mostrarStatus(msg, "âŒ Login invÃ¡lido", "erro");
      return;
    }

    passageiro = p;
    mostrarStatus(msg, `âœ… Logado com sucesso!`, "sucesso");
    
    // Mostra seÃ§Ã£o da corrida e informaÃ§Ãµes do usuÃ¡rio
    document.getElementById("corridaSection").style.display = "block";
    document.getElementById("userInfo").style.display = "block";
    document.getElementById("saudacao").textContent = `OlÃ¡, ${p.nome}!`;
    document.getElementById("userEmail").textContent = p.email;
    
  } catch (e) {
    mostrarStatus(msg, "âŒ Erro de conexÃ£o", "erro");
  } finally {
    executando = false;
  }
}

// ---- BOTÃƒO 2: BUSCAR CORRIDA ----
async function buscarCorrida() {
  if (executando) return;
  executando = true;
  
  const statusBuscar = document.getElementById("statusBuscar");
  
  if (!passageiro) {
    mostrarStatus(statusBuscar, "âŒ FaÃ§a login primeiro", "erro");
    executando = false;
    return;
  }

  mostrarStatus(statusBuscar, "ğŸŸ¡ Buscando sua corrida...", "processando");

  try {
    const res = await fetch(`${API}/corridas/passageiro/${passageiro.id}`);
    const corridas = await res.json();
    
    if (corridas.length === 0) {
      mostrarStatus(statusBuscar, "âŒ Nenhuma corrida encontrada", "erro");
      return;
    }

    // Pega a Ãºltima corrida
    corridaAtual = corridas[0];
    mostrarStatus(statusBuscar, "âœ… Corrida encontrada!", "sucesso");
    
    // Atualiza informaÃ§Ãµes na tela
    atualizarInformacoes();
    
  } catch (e) {
    mostrarStatus(statusBuscar, "âŒ Erro ao buscar corrida", "erro");
  } finally {
    executando = false;
  }
}

// ---- BOTÃƒO 3: VERIFICAR MOTORISTA ----
async function verificarMotorista() {
  if (executando) return;
  executando = true;
  
  const statusMotorista = document.getElementById("statusMotorista");
  
  if (!corridaAtual) {
    mostrarStatus(statusMotorista, "âŒ Busque uma corrida primeiro", "erro");
    executando = false;
    return;
  }

  mostrarStatus(statusMotorista, "ğŸŸ¡ Verificando motorista...", "processando");

  try {
    // Busca a corrida atualizada para ver se tem motorista
    const res = await fetch(`${API}/corridas/passageiro/${passageiro.id}`);
    const corridas = await res.json();
    
    if (corridas.length === 0) {
      mostrarStatus(statusMotorista, "âŒ Corrida nÃ£o encontrada", "erro");
      return;
    }

    const corridaAtualizada = corridas[0];
    
    if (corridaAtualizada.motorista_nome && corridaAtualizada.motorista_id) {
      // Motorista encontrado!
      corridaAtual = corridaAtualizada;
      atualizarInformacoes();
      mostrarStatus(statusMotorista, `âœ… Motorista encontrado: ${corridaAtualizada.motorista_nome} estÃ¡ a caminho!`, "sucesso");
    } else {
      mostrarStatus(statusMotorista, "âŒ Nenhum motorista aceitou sua corrida ainda", "erro");
    }
    
  } catch (e) {
    mostrarStatus(statusMotorista, "âŒ Erro ao verificar motorista", "erro");
  } finally {
    executando = false;
  }
}

// ---- BOTÃƒO 4: CARREGAR MAPA ----
function carregarMapa() {
  if (executando) return;
  executando = true;
  
  const statusMapa = document.getElementById("statusMapa");
  
  if (!corridaAtual) {
    mostrarStatus(statusMapa, "âŒ Busque uma corrida primeiro", "erro");
    executando = false;
    return;
  }

  mostrarStatus(statusMapa, "ğŸŸ¡ Carregando mapa...", "processando");

  try {
    // Remove mapa anterior se existir
    if (mapa) {
      mapa.remove();
    }
    
    // Cria novo mapa
    mapa = L.map('map').setView([corridaAtual.origem_lat, corridaAtual.origem_lng], 13);
    
    // Adiciona tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap'
    }).addTo(mapa);
    
    // Marcador de origem
    L.marker([corridaAtual.origem_lat, corridaAtual.origem_lng])
      .addTo(mapa)
      .bindPopup("ğŸ“ Sua LocalizaÃ§Ã£o")
      .openPopup();
      
    // Marcador de destino
    L.marker([corridaAtual.destino_lat, corridaAtual.destino_lng])
      .addTo(mapa)
      .bindPopup("ğŸ¯ Destino");
    
    // Rota entre pontos (se a biblioteca carregou)
    if (L.Routing) {
      L.Routing.control({
        waypoints: [
          L.latLng(corridaAtual.origem_lat, corridaAtual.origem_lng),
          L.latLng(corridaAtual.destino_lat, corridaAtual.destino_lng)
        ],
        routeWhileDragging: false,
        showAlternatives: false,
        lineOptions: {
          styles: [{color: '#dc3545', opacity: 0.8, weight: 6}]
        }
      }).addTo(mapa);
    }
    
    mostrarStatus(statusMapa, "âœ… Mapa carregado com rota!", "sucesso");
    
  } catch (e) {
    mostrarStatus(statusMapa, "âŒ Erro ao carregar mapa", "erro");
  } finally {
    executando = false;
  }
}

// ---- BOTÃƒO 5: ATUALIZAR STATUS ----
async function atualizarStatus() {
  if (executando) return;
  executando = true;
  
  const statusAtualizar = document.getElementById("statusAtualizar");
  
  if (!corridaAtual) {
    mostrarStatus(statusAtualizar, "âŒ Busque uma corrida primeiro", "erro");
    executando = false;
    return;
  }

  mostrarStatus(statusAtualizar, "ğŸŸ¡ Atualizando status...", "processando");

  try {
    // Atualiza status para "esperando motorista"
    const dados = { status: "esperando motorista" };
    
    const res = await fetch(`${API}/corridas/${corridaAtual.id}/status`, {
      method: 'PUT',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(dados)
    });

    if (res.ok) {
      mostrarStatus(statusAtualizar, "âœ… Status atualizado: 'esperando motorista'", "sucesso");
      // Atualiza informaÃ§Ãµes locais
      corridaAtual.status = "esperando motorista";
      atualizarInformacoes();
    } else {
      throw new Error("Erro ao atualizar status");
    }
    
  } catch (e) {
    mostrarStatus(statusAtualizar, "âŒ Erro ao atualizar status", "erro");
  } finally {
    executando = false;
  }
}

// ---- BOTÃƒO 6: CHAT ----
function abrirChat() {
  const statusChat = document.getElementById("statusChat");
  
  if (!corridaAtual || !corridaAtual.motorista_id) {
    mostrarStatus(statusChat, "âŒ Aguarde um motorista aceitar sua corrida", "erro");
    return;
  }
  
  mostrarStatus(statusChat, "ğŸ’¬ Abrindo chat com o motorista...", "processando");
  
  // SimulaÃ§Ã£o de abertura de chat
  setTimeout(() => {
    mostrarStatus(statusChat, "âœ… Chat iniciado com o motorista!", "sucesso");
    alert(`ğŸ’¬ Chat com ${corridaAtual.motorista_nome}\n\nDigite sua mensagem:`);
  }, 1000);
}

// ---- FUNÃ‡ÃƒO AUXILIAR: ATUALIZAR INFORMAÃ‡Ã•ES ----
function atualizarInformacoes() {
  if (!corridaAtual) return;
  
  document.getElementById("infoValor").textContent = `R$ ${corridaAtual.valor}`;
  document.getElementById("infoOrigem").textContent = `${corridaAtual.origem_lat.toFixed(6)}, ${corridaAtual.origem_lng.toFixed(6)}`;
  document.getElementById("infoDestino").textContent = `${corridaAtual.destino_lat.toFixed(6)}, ${corridaAtual.destino_lng.toFixed(6)}`;
  document.getElementById("infoStatus").textContent = traduzirStatus(corridaAtual.status);
  document.getElementById("infoMotorista").textContent = corridaAtual.motorista_nome || "Aguardando motorista...";
}

// ---- FUNÃ‡ÃƒO AUXILIAR: TRADUZIR STATUS ----
function traduzirStatus(status) {
  const statusMap = {
    'solicitada': 'ğŸŸ¡ Aguardando',
    'esperando motorista': 'ğŸŸ¡ Esperando Motorista',
    'em andamento': 'â¡ï¸ Em Andamento',
    'em casa': 'ğŸ  Em Casa',
    'concluida': 'âœ… ConcluÃ­da'
  };
  return statusMap[status] || status;
}

// ---- FUNÃ‡ÃƒO AUXILIAR: MOSTRAR STATUS ----
function mostrarStatus(elemento, mensagem, tipo) {
  elemento.innerHTML = mensagem;
  elemento.className = `status ${tipo}`;
}

// ---- INICIALIZAÃ‡ÃƒO ----
window.onload = function() {
  verificarIdUrl();
};
</script>
</body>
</html>
