<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Motorista - Executar Corrida</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  body { 
    margin:0; 
    font-family: Arial, sans-serif; 
    background:#f4f4f4; 
  }
  .container { 
    width:100%; 
    max-width:500px; 
    margin:auto; 
    padding:20px; 
  }
  .logo {
    text-align: center;
    color: #ff0000;
    font-size: 24px;
    font-weight: bold;
    margin-bottom: 20px;
  }
  .login-section {
    background: white;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 15px;
  }
  input, button { 
    width:100%; 
    padding:10px; 
    margin:8px 0; 
    border-radius:4px; 
    border:1px solid #bbb; 
    box-sizing: border-box;
  }
  button { 
    background:#007bff; 
    color:white; 
    border:none; 
    cursor: pointer;
  }
  button:hover { 
    background:#0056b3; 
  }
  .botoes-corrida {
    display: flex;
    gap: 10px;
    margin: 15px 0;
  }
  .botoes-corrida button {
    flex: 1;
    padding: 12px;
  }
  #btnVerificar { background: #17a2b8; }
  #btnVerificar:hover { background: #138496; }
  #btnCarregarMapa { background: #28a745; }
  #btnCarregarMapa:hover { background: #218838; }
  #btnTerminar { background: #ffc107; color: black; }
  #btnTerminar:hover { background: #e0a800; }
  #btnPagar { background: #dc3545; }
  #btnPagar:hover { background: #c82333; }
  
  #infoCorrida {
    background: white;
    padding: 15px;
    border-radius: 8px;
    margin: 15px 0;
  }
  #map { 
    width:100%; 
    height:70vh; 
    background:#eee;
    border-radius: 8px;
    margin-top: 15px;
  }
  #msg { 
    text-align:center; 
    color:red; 
    margin: 10px 0;
  }
  .readonly-input {
    background: #f8f9fa;
    border: 1px solid #ced4da;
    color: #495057;
  }
</style>
</head>
<body>

<div class="container">
  <!-- Logo -->
  <div class="logo">MOVEME</div>

  <!-- Login -->
  <div class="login-section">
    <h2 style="text-align:center; margin-bottom:20px;">Login Motorista</h2>
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="senha" placeholder="Senha">
    <button id="btnLogin">Entrar</button>
    <p id="msg"></p>
  </div>

  <!-- Bot√µes -->
  <div class="botoes-corrida">
    <button id="btnVerificar">üîç Verificar Corrida</button>
    <button id="btnCarregarMapa">üó∫Ô∏è Carregar Mapa</button>
  </div>

  <div class="botoes-corrida">
    <button id="btnTerminar">üèÅ Terminar Corrida</button>
    <button id="btnPagar">üí≥ Pagar</button>
  </div>

  <!-- Informa√ß√µes da Corrida -->
  <div id="infoCorrida" style="display:none;">
    <h3>Corrida Atual:</h3>
    <input type="text" id="infoPassageiro" class="readonly-input" readonly placeholder="Nome do Passageiro">
    <input type="text" id="infoValor" class="readonly-input" readonly placeholder="Valor da Corrida">
    <input type="text" id="infoOrigem" class="readonly-input" readonly placeholder="Origem">
    <input type="text" id="infoDestino" class="readonly-input" readonly placeholder="Destino">
  </div>

  <!-- Mapa -->
  <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const API = "https://moveme-backend-v80p.onrender.com";
let map;
let motoristaLogado = null;
let corridaAtual = null;

// ---- LOGIN MOTORISTA ----
document.getElementById("btnLogin").onclick = async () => {
  const email = document.getElementById("email").value.trim();
  const senha = document.getElementById("senha").value.trim();
  const msg = document.getElementById("msg");

  msg.textContent = "";

  try {
    const res = await fetch(`${API}/motora`);
    const dados = await res.json();

    const motorista = dados.find(x => x.email === email && x.senha === senha);

    if (!motorista) {
      msg.textContent = "Login inv√°lido";
      return;
    }

    motoristaLogado = motorista;
    msg.style.color = "green";
    msg.textContent = "Logado com sucesso";

  } catch (e) {
    msg.textContent = "Erro de conex√£o";
  }
};

// ---- VERIFICAR CORRIDA ----
document.getElementById("btnVerificar").onclick = async () => {
  if (!motoristaLogado) {
    alert("Fa√ßa login primeiro");
    return;
  }

  try {
    const res = await fetch(`${API}/corridas/motorista/${motoristaLogado.id}`);
    const corridas = await res.json();
    
    // Filtra apenas corridas em andamento
    const corridaAndamento = corridas.find(c => c.status === 'em andamento');
    
    if (!corridaAndamento) {
      alert("Nenhuma corrida em andamento encontrada");
      return;
    }

    corridaAtual = corridaAndamento;
    
    // Preenche informa√ß√µes da corrida
    document.getElementById('infoCorrida').style.display = 'block';
    document.getElementById('infoPassageiro').value = corridaAtual.passageiro_nome;
    document.getElementById('infoValor').value = `R$ ${corridaAtual.valor}`;
    
    // Converte coordenadas para endere√ßos
    const origem = await converterLatLngParaEndereco(corridaAtual.origem_lat, corridaAtual.origem_lng);
    const destino = await converterLatLngParaEndereco(corridaAtual.destino_lat, corridaAtual.destino_lng);
    
    document.getElementById('infoOrigem').value = origem;
    document.getElementById('infoDestino').value = destino;
    
    alert("Corrida encontrada! Carregue o mapa para iniciar.");

  } catch (e) {
    alert("Erro ao buscar corrida");
  }
};

// ---- CARREGAR MAPA ----
document.getElementById("btnCarregarMapa").onclick = () => {
  if (!corridaAtual) {
    alert("Verifique a corrida primeiro");
    return;
  }

  carregarMapaCorrida();
};

// ---- TERMINAR CORRIDA ----
document.getElementById("btnTerminar").onclick = async () => {
  if (!corridaAtual) {
    alert("Nenhuma corrida ativa");
    return;
  }

  try {
    // Atualiza status do passageiro para "em casa"
    await fetch(`${API}/corridas/${corridaAtual.id}/status`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ status: 'em casa' })
    });

    alert("Corrida terminada! Aguardando pagamento.");
    
  } catch (e) {
    alert("Erro ao terminar corrida");
  }
};

// ---- PAGAR CORRIDA ----
document.getElementById("btnPagar").onclick = async () => {
  if (!corridaAtual || !motoristaLogado) {
    alert("Nenhuma corrida ativa");
    return;
  }

  try {
    // 1. Atualiza corrida - marca como paga e limpa dados do motorista
    await fetch(`${API}/corridas/${corridaAtual.id}/status`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        modo_pagamento: 'pago',
        motorista_nome: null,
        motorista_id: null
      })
    });

    // 2. Busca dados atuais do motorista para calcular novos totais
    const resMotora = await fetch(`${API}/motora`);
    const motoristas = await resMotora.json();
    const motoristaAtual = motoristas.find(m => m.id === motoristaLogado.id);

    if (!motoristaAtual) {
      alert("Erro: Motorista n√£o encontrado");
      return;
    }

    // 3. Calcula novos valores
    const novasCorridasDia = (motoristaAtual.total_corridas_dia || 0) + 1;
    const novoValorDia = (parseFloat(motoristaAtual.total_valor_dia) || 0) + parseFloat(corridaAtual.valor);

    // 4. Atualiza motorista - hist√≥rico di√°rio e status livre
    await fetch(`${API}/motora/${motoristaLogado.id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        status: 'livre',
        corrida_id: null,
        passageiro_id: null,
        total_corridas_dia: novasCorridasDia,
        total_valor_dia: novoValorDia,
        latitude: null,
        longitude: null
      })
    });

    alert("Pagamento confirmado! Corrida finalizada.");
    document.getElementById('infoCorrida').style.display = 'none';
    corridaAtual = null;
    
  } catch (e) {
    alert("Erro ao processar pagamento");
  }
};

// ---- FUN√á√ïES AUXILIARES ----
async function converterLatLngParaEndereco(lat, lng) {
  try {
    const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
    const data = await response.json();
    
    if (data.address) {
      const addr = data.address;
      return `${addr.road || ''} ${addr.house_number || ''}, ${addr.suburb || addr.neighbourhood || ''}/${addr.state || ''}`.trim();
    }
    return "Endere√ßo n√£o encontrado";
  } catch (e) {
    return "Erro ao buscar endere√ßo";
  }
}

// ---- FUN√á√ÉO CORRIGIDA: CARREGAR MAPA DA CORRIDA DO PASSAGEIRO ----
function carregarMapaCorrida() {
  if (map) {
    map.remove();
  }

  // Centraliza no ponto m√©dio entre ORIGEM e DESTINO do PASSAGEIRO
  const centerLat = (corridaAtual.origem_lat + corridaAtual.destino_lat) / 2;
  const centerLng = (corridaAtual.origem_lng + corridaAtual.destino_lng) / 2;
  
  map = L.map('map').setView([centerLat, centerLng], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

  // Marcador da ORIGEM do passageiro (onde pegou)
  L.marker([corridaAtual.origem_lat, corridaAtual.origem_lng])
    .addTo(map)
    .bindPopup(`<b>üìç Origem</b><br>${corridaAtual.passageiro_nome}`)
    .openPopup();

  // Marcador do DESTINO do passageiro
  L.marker([corridaAtual.destino_lat, corridaAtual.destino_lng])
    .addTo(map)
    .bindPopup(`<b>üéØ Destino</b><br>${corridaAtual.passageiro_nome}`);

  // Rota completa: ORIGEM ‚Üí DESTINO do passageiro
  const rota = [
    [corridaAtual.origem_lat, corridaAtual.origem_lng],
    [corridaAtual.destino_lat, corridaAtual.destino_lng]
  ];
  
  L.polyline(rota, {color: 'blue'}).addTo(map);
  
  alert("Mapa da corrida do passageiro carregado!");
}
</script>
</body>
</html>
