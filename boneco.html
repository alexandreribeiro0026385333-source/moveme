<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Login Passageiro</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  body { 
    margin:0; 
    font-family: Arial, sans-serif; 
    background:#f4f4f4; 
  }
  .container { 
    width:100%; 
    max-width:500px; 
    margin:auto; 
    padding:20px; 
  }
  .login-section {
    background: white;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 15px;
  }
  input, button, select { 
    width:100%; 
    padding:10px; 
    margin:8px 0; 
    border-radius:4px; 
    border:1px solid #bbb; 
    box-sizing: border-box;
  }
  button { 
    background:#28a745; 
    color:white; 
    border:none; 
    cursor: pointer;
  }
  button:hover { 
    background:#218838; 
  }
  .botoes-corrida {
    display: flex;
    gap: 10px;
    margin: 15px 0;
  }
  .botoes-corrida button {
    flex: 1;
    padding: 12px;
  }
  #btnSolicitar { background: #17a2b8; }
  #btnSolicitar:hover { background: #138496; }
  #btnTerminar { background: #dc3545; }
  #btnTerminar:hover { background: #c82333; }
  #btnPagar { background: #ffc107; color: black; }
  #btnPagar:hover { background: #e0a800; }
  
  #map { 
    width:100%; 
    height:70vh; 
    background:#eee;
    border-radius: 8px;
  }
  #msg { 
    text-align:center; 
    color:red; 
    margin: 10px 0;
  }
  .modal {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
  }
  .modal-content {
    background: white;
    margin: 10% auto;
    padding: 20px;
    width: 90%;
    max-width: 400px;
    border-radius: 8px;
  }
</style>
</head>
<body>

<div class="container">
  <!-- Login -->
  <div class="login-section">
    <h2 style="text-align:center; margin-bottom:20px;">Login Passageiro</h2>
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="senha" placeholder="Senha">
    <button id="btnLogin">Entrar</button>
    <p id="msg"></p>
  </div>

  <!-- Botões -->
  <div class="botoes-corrida">
    <button id="btnSolicitar">Solicitar Corrida</button>
    <button id="btnTerminar">Terminar Corrida</button>
    <button id="btnPagar">Pagar Corrida</button>
  </div>

  <!-- MAPA GRANDE -->
  <div id="map"></div>
</div>

<!-- Modal Solicitar Corrida -->
<div id="modalCorrida" class="modal">
  <div class="modal-content">
    <h3>Solicitar Corrida</h3>
    <input type="text" id="origem" placeholder="Endereço de origem">
    <input type="text" id="destino" placeholder="Endereço de destino">
    <input type="number" id="valor" placeholder="Valor R$" step="0.01">
    <select id="modoPagamento">
      <option value="dinheiro">Dinheiro</option>
      <option value="cartao">Cartão</option>
      <option value="pix">PIX</option>
    </select>
    <div class="botoes-corrida">
      <button id="btnConfirmar">Confirmar</button>
      <button onclick="fecharModal()" style="background:#6c757d;">Cancelar</button>
    </div>
  </div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const API = "https://moveme-backend-v80p.onrender.com";
let map, window.passageiro;

// ---- LOGIN PASSAGEIRO ----
document.getElementById("btnLogin").onclick = async () => {
  const email = document.getElementById("email").value.trim();
  const senha = document.getElementById("senha").value.trim();
  const msg = document.getElementById("msg");

  msg.textContent = "";

  try {
    const res = await fetch(`${API}/bonecos`);
    const dados = await res.json();

    const p = dados.find(x => x.email === email && x.senha === senha);

    if (!p) {
      msg.textContent = "Login inválido";
      return;
    }

    window.passageiro = p;
    msg.style.color = "green";
    msg.textContent = "Logado com sucesso";

    carregarMapa(p);
    carregarMinhasCorridas(p.id);

  } catch (e) {
    msg.textContent = "Erro de conexão";
  }
};

// ---- MAPA COM LEAFLET ----
function carregarMapa(passageiro) {
  const lat = passageiro.latitude || -15.7975;
  const lng = passageiro.longitude || -47.8919;
  
  map = L.map('map').setView([lat, lng], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

  L.marker([lat, lng])
    .addTo(map)
    .bindPopup(`<b>${passageiro.nome}</b><br>Passageiro`)
    .openPopup();
}

// ---- SOLICITAR CORRIDA ----
document.getElementById("btnSolicitar").onclick = () => {
  if (!window.passageiro) {
    alert("Faça login primeiro");
    return;
  }
  document.getElementById("modalCorrida").style.display = "block";
};

document.getElementById("btnConfirmar").onclick = async () => {
  const origem = document.getElementById("origem").value;
  const destino = document.getElementById("destino").value;
  const valor = document.getElementById("valor").value;
  const modoPagamento = document.getElementById("modoPagamento").value;

  if (!origem || !destino || !valor) {
    alert("Preencha todos os campos");
    return;
  }

  try {
    // Converter endereços em coordenadas
    const coordOrigem = await enderecoParaCoordenadas(origem);
    const coordDestino = await enderecoParaCoordenadas(destino);

    const corridaData = {
      passageiro_id: window.passageiro.id,
      passageiro_nome: window.passageiro.nome,
      origem_lat: coordOrigem.lat,
      origem_lng: coordOrigem.lng,
      destino_lat: coordDestino.lat,
      destino_lng: coordDestino.lng,
      valor: parseFloat(valor),
      modo_pagamento: modoPagamento
    };

    const res = await fetch(`${API}/corridas/nova`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(corridaData)
    });

    if (res.ok) {
      alert("Corrida solicitada com sucesso!");
      fecharModal();
      carregarMinhasCorridas(window.passageiro.id);
    } else {
      alert("Erro ao solicitar corrida");
    }
  } catch (e) {
    alert("Erro ao processar endereços");
  }
};

// ---- GEOCODING ----
async function enderecoParaCoordenadas(endereco) {
  const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(endereco)}&format=json&limit=1`;
  const res = await fetch(url, { headers: {'User-Agent': 'MoveMeApp/1.0'} });
  const data = await res.json();
  if (data.length > 0) {
    return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
  }
  throw new Error("Endereço não encontrado");
}

// ---- MINHAS CORRIDAS ----
async function carregarMinhasCorridas(idPassageiro) {
  try {
    const res = await fetch(`${API}/corridas/passageiro/${idPassageiro}`);
    const corridas = await res.json();
    window.corridaAtual = corridas.find(c => c.status === 'andamento');
    
    if (window.corridaAtual) {
      console.log("Corrida em andamento:", window.corridaAtual);
    }
  } catch (e) {
    console.log("Erro ao carregar corridas");
  }
}

// ---- BOTÕES ----
document.getElementById("btnTerminar").onclick = () => {
  if (!window.corridaAtual) alert("Nenhuma corrida ativa.");
  else alert("Corrida terminada.");
};

document.getElementById("btnPagar").onclick = () => {
  if (!window.corridaAtual) alert("Nenhuma corrida ativa.");
  else alert("Corrida paga.");
};

function fecharModal() {
  document.getElementById("modalCorrida").style.display = "none";
}
</script>
</body>
</html>
