<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Solicitar Corrida - Passageiro</title>
<style>
  body { margin:0; font-family: Arial, sans-serif; background:#f4f4f4; }
  .container { width:100%; max-width:500px; margin:auto; padding:20px; }
  .login-section, .solicitacao-section, .user-info { 
    background: white; 
    padding: 20px; 
    border-radius: 8px; 
    margin-bottom: 15px; 
  }
  input, button { width:100%; padding:10px; margin:8px 0; border-radius:4px; border:1px solid #bbb; box-sizing: border-box; }
  button { cursor: pointer; }
  .status { padding: 10px; border-radius: 4px; margin: 5px 0; }
  .processando { background: #fff3cd; color: #856404; }
  .sucesso { background: #d1edff; color: #155724; }
  .erro { background: #f8d7da; color: #721c24; }
  small { color: #666; font-size: 12px; }
  .logo {
    text-align: center;
    color: red;
    font-size: 24px;
    font-weight: bold;
    margin-bottom: 20px;
  }
  .botoes-inferiores {
    display: flex;
    gap: 10px;
    margin-top: 15px;
  }
  .botoes-inferiores button {
    flex: 1;
  }
  #btnChat { background: #6f42c1; color: white; }
</style>
</head>
<body>

<div class="container">
  <!-- Logo -->
  <div class="logo">MOVEME</div>

  <!-- Login -->
  <div class="login-section" id="loginSection">
    <h2 style="text-align:center; margin-bottom:20px;">Login Passageiro</h2>
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="senha" placeholder="Senha">
    <button onclick="fazerLogin()" style="background:#007bff; color:white;">üîë Fazer Login</button>
    <div id="msg"></div>
  </div>

  <!-- Informa√ß√µes do Usu√°rio -->
  <div class="user-info" id="userInfo" style="display:none;">
    <h3 id="saudacao"></h3>
    <p><strong>ID:</strong> <span id="userId"></span></p>
    <p><strong>Email:</strong> <span id="userEmail"></span></p>
  </div>

  <!-- Solicita√ß√£o de Corrida -->
  <div class="solicitacao-section">
    <h3 style="text-align:center;">Solicitar Corrida</h3>
    
    <!-- Origem -->
    <div class="input-group">
      <label>Endere√ßo de Origem:</label>
      <input type="text" id="origem" placeholder="Ex: Rua Sebasti√£o de Melo 447, Nova Igua√ßu, RJ">
      <small>üí° Digite: Rua, N√∫mero, Cidade, Estado</small>
      <button onclick="definirOrigem()" style="background:#17a2b8; color:white;">üìç Definir Origem</button>
      <div id="statusOrigem"></div>
    </div>

    <!-- Destino -->
    <div class="input-group" style="margin-top: 15px;">
      <label>Endere√ßo de Destino:</label>
      <input type="text" id="destino" placeholder="Ex: Avenida Brasil 2000, Centro, Rio de Janeiro, RJ">
      <small>üí° Digite: Rua, N√∫mero, Cidade, Estado</small>
      <button onclick="definirDestino()" style="background:#6f42c1; color:white;">üéØ Definir Destino</button>
      <div id="statusDestino"></div>
    </div>

    <!-- Calcular Valor -->
    <div style="margin-top: 15px;">
      <button onclick="calcularValor()" style="background:#ffc107; color:black;">üí∞ Calcular Valor da Corrida</button>
      <div id="statusCalcular"></div>
    </div>

    <!-- Valor Calculado -->
    <div id="valorSection" style="display:none; margin-top: 15px; padding: 10px; background: #e9ecef; border-radius: 4px;">
      <h4>üí∞ Valor da Corrida: <span id="valorCorrida">R$ 0,00</span></h4>
    </div>

    <!-- Confirmar -->
    <div style="margin-top: 15px;">
      <button onclick="confirmarCorrida()" style="background:#28a745; color:white;">‚úÖ Confirmar Corrida</button>
      <div id="statusConfirmar"></div>
    </div>

    <!-- Bot√µes Inferiores -->
    <div class="botoes-inferiores">
      <button onclick="abrirChat()" id="btnChat">üí¨ Chat</button>
    </div>
  </div>
</div>

<script>
// ---- VARI√ÅVEIS GLOBAIS ----
const API = "https://moveme-backend-v80p.onrender.com";
let passageiro = null, origemCoords = null, destinoCoords = null, valorCorrida = 0;
let corridaAtual = null;

// ---- FUN√á√ÉO 1: LOGIN ----
function fazerLogin() {
  const email = document.getElementById("email").value;
  const senha = document.getElementById("senha").value;
  const msg = document.getElementById("msg");

  if (!email || !senha) {
    mostrarStatus(msg, "‚ùå Digite email e senha", "erro");
    return;
  }

  mostrarStatus(msg, "üü° Verificando login...", "processando");

  fetch(API + "/bonecos")
    .then(res => res.json())
    .then(dados => {
      const p = dados.find(x => x.email === email && x.senha === senha);
      
      if (!p) {
        mostrarStatus(msg, "‚ùå Login inv√°lido", "erro");
        return;
      }

      passageiro = p;
      mostrarStatus(msg, "‚úÖ Logado com sucesso", "sucesso");
      mostrarInfoUsuario(p);
    })
    .catch(e => {
      mostrarStatus(msg, "‚ùå Erro de conex√£o", "erro");
    });
}

// ---- MOSTRAR INFORMA√á√ïES DO USU√ÅRIO ----
function mostrarInfoUsuario(passageiro) {
  const userInfo = document.getElementById("userInfo");
  const saudacao = document.getElementById("saudacao");
  const userId = document.getElementById("userId");
  const userEmail = document.getElementById("userEmail");
  
  // Pega primeiro nome
  const firstName = passageiro.nome.split(' ')[0];
  
  saudacao.innerHTML = "üëã Ol√°, " + firstName + "!";
  userId.innerHTML = passageiro.id;
  userEmail.innerHTML = passageiro.email;
  
  userInfo.style.display = 'block';
  document.getElementById('loginSection').style.display = 'none';
}

// ---- ABRIR CHAT ----
function abrirChat() {
  if (!passageiro) {
    alert("Fa√ßa login primeiro");
    return;
  }

  const chatUrl = "chat.html?user_type=passageiro&user_id=" + passageiro.id;
  window.open(chatUrl, '_blank');
}

// ---- FUN√á√ÉO 2: DEFINIR ORIGEM ----
function definirOrigem() {
  const endereco = document.getElementById("origem").value;
  const statusOrigem = document.getElementById("statusOrigem");
  
  if (!endereco) {
    mostrarStatus(statusOrigem, "‚ùå Digite endere√ßo de origem", "erro");
    return;
  }

  mostrarStatus(statusOrigem, "üü° Convertendo endere√ßo...", "processando");

  enderecoParaCoordenadas(endereco)
    .then(coords => {
      origemCoords = coords;
      mostrarStatus(statusOrigem, "‚úÖ Origem definida", "sucesso");
    })
    .catch(e => {
      mostrarStatus(statusOrigem, "‚ùå Endere√ßo n√£o encontrado", "erro");
    });
}

// ---- FUN√á√ÉO 3: DEFINIR DESTINO ----
function definirDestino() {
  const endereco = document.getElementById("destino").value;
  const statusDestino = document.getElementById("statusDestino");
  
  if (!endereco) {
    mostrarStatus(statusDestino, "‚ùå Digite endere√ßo de destino", "erro");
    return;
  }

  mostrarStatus(statusDestino, "üü° Convertendo endere√ßo...", "processando");

  enderecoParaCoordenadas(endereco)
    .then(coords => {
      destinoCoords = coords;
      mostrarStatus(statusDestino, "‚úÖ Destino definido", "sucesso");
    })
    .catch(e => {
      mostrarStatus(statusDestino, "‚ùå Endere√ßo n√£o encontrado", "erro");
    });
}

// ---- FUN√á√ÉO 4: CALCULAR VALOR ----
function calcularValor() {
  const statusCalcular = document.getElementById("statusCalcular");
  
  if (!origemCoords || !destinoCoords) {
    mostrarStatus(statusCalcular, "‚ùå Defina origem e destino primeiro", "erro");
    return;
  }

  mostrarStatus(statusCalcular, "üü° Calculando dist√¢ncia...", "processando");

  const distancia = calcularDistancia(origemCoords, destinoCoords);
  valorCorrida = distancia * 2.00;
  
  document.getElementById("valorCorrida").innerHTML = "R$ " + valorCorrida.toFixed(2);
  document.getElementById("valorSection").style.display = "block";
  mostrarStatus(statusCalcular, "‚úÖ " + distancia.toFixed(2) + " km √ó R$2,00 = R$ " + valorCorrida.toFixed(2), "sucesso");
}

// ---- FUN√á√ÉO 5: CONFIRMAR CORRIDA ----
function confirmarCorrida() {
  const statusConfirmar = document.getElementById("statusConfirmar");
  
  if (!origemCoords || !destinoCoords) {
    mostrarStatus(statusConfirmar, "‚ùå Defina origem e destino", "erro");
    return;
  }

  if (valorCorrida === 0) {
    mostrarStatus(statusConfirmar, "‚ùå Calcule o valor primeiro", "erro");
    return;
  }

  const email = document.getElementById("email").value;
  let passageiro_nome = passageiro ? passageiro.nome : email;
  
  if (!passageiro_nome) {
    mostrarStatus(statusConfirmar, "‚ùå Digite um email", "erro");
    return;
  }

  mostrarStatus(statusConfirmar, "üü° Salvando corrida...", "processando");

  const corridaData = {
    passageiro_id: passageiro ? passageiro.id : 0,
    passageiro_nome: passageiro_nome,
    origem_lat: origemCoords.lat,
    origem_lng: origemCoords.lng,
    destino_lat: destinoCoords.lat,
    destino_lng: destinoCoords.lng,
    valor: valorCorrida,
    status: 'solicitada'
  };

  fetch(API + "/corridas/nova", {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(corridaData)
  })
  .then(res => res.json())
  .then(data => {
    mostrarStatus(statusConfirmar, "‚úÖ Corrida salva! Redirecionando...", "sucesso");
    
    // Salva a corrida atual para usar no chat
    corridaAtual = corridaData;
    corridaAtual.id = data.id || Date.now(); // ID tempor√°rio se n√£o vier do servidor
    
    setTimeout(() => {
      // Passa ID do passageiro para a pr√≥xima p√°gina
      window.location.href = "mapadoboneco.html?passageiro_id=" + passageiro.id;
    }, 2000);
  })
  .catch(e => {
    mostrarStatus(statusConfirmar, "‚ùå Erro ao salvar corrida", "erro");
  });
}

// ---- FUN√á√ïES AUXILIARES ----
function enderecoParaCoordenadas(endereco) {
  return fetch("https://nominatim.openstreetmap.org/search?format=json&q=" + encodeURIComponent(endereco))
    .then(res => res.json())
    .then(data => {
      if (data.length > 0) {
        return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
      }
      throw new Error("Endere√ßo n√£o encontrado");
    });
}

function calcularDistancia(coord1, coord2) {
  const R = 6371;
  const dLat = (coord2.lat - coord1.lat) * Math.PI / 180;
  const dLon = (coord2.lng - coord1.lng) * Math.PI / 180;
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
    Math.cos(coord1.lat * Math.PI / 180) * Math.cos(coord2.lat * Math.PI / 180) * 
    Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

function mostrarStatus(elemento, mensagem, tipo) {
  elemento.innerHTML = mensagem;
  elemento.className = "status " + tipo;
}
</script>
</body>
</html>
