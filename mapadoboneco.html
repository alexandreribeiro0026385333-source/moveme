<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Acompanhar Corrida - Passageiro</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
<style>
  body { margin:0; font-family: Arial, sans-serif; background:#f4f4f4; }
  .container { width:100%; max-width:500px; margin:auto; padding:20px; }
  .login-section, .corrida-section { background: white; padding: 20px; border-radius: 8px; margin-bottom: 15px; }
  input, button { width:100%; padding:10px; margin:8px 0; border-radius:4px; border:1px solid #bbb; box-sizing: border-box; }
  button { cursor: pointer; background:#007bff; color:white; border:none; }
  button:hover { background:#0056b3; }
  #map { width:100%; height:60vh; background:#eee; border-radius: 8px; margin:10px 0; }
  .status { padding: 10px; border-radius: 4px; margin: 5px 0; }
  .processando { background: #fff3cd; color: #856404; }
  .sucesso { background: #d1edff; color: #155724; }
  .erro { background: #f8d7da; color: #721c24; }
  .info { background: #e9ecef; padding: 15px; border-radius: 8px; margin: 10px 0; }
</style>
</head>
<body>

<div class="container">
  <!-- Login -->
  <div class="login-section">
    <h2 style="text-align:center; margin-bottom:20px;">Acompanhar Corrida</h2>
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="senha" placeholder="Senha">
    <button onclick="fazerLogin()">ğŸ”‘ Entrar</button>
    <div id="msg"></div>
  </div>

  <!-- Info da Corrida -->
  <div id="corridaSection" class="corrida-section" style="display:none;">
    <h3 style="text-align:center;">Sua Corrida</h3>
    <div class="info">
      <p><strong>ğŸ’° Valor:</strong> <span id="infoValor">R$ 0,00</span></p>
      <p><strong>ğŸ“ Origem:</strong> <span id="infoOrigem">-</span></p>
      <p><strong>ğŸ¯ Destino:</strong> <span id="infoDestino">-</span></p>
      <p><strong>ğŸš— Status:</strong> <span id="infoStatus">-</span></p>
      <p><strong>ğŸ‘¤ Motorista:</strong> <span id="infoMotorista">-</span></p>
    </div>
    
    <!-- Mapa -->
    <div id="map"></div>
    
    <!-- Atualizar -->
    <button onclick="verificarCorrida()">ğŸ”„ Atualizar Status</button>
    <div id="statusAtualizar"></div>
  </div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
<script>
// ---- VARIÃVEIS GLOBAIS ----
const API = "https://moveme-backend-v80p.onrender.com";
let passageiro = null, mapa = null, corridaAtual = null;
let timerAtualizacao = null;
let executando = false;

// ---- FUNÃ‡ÃƒO 1: LOGIN ----
async function fazerLogin() {
  if (executando) {
    console.log("â³ Login jÃ¡ em execuÃ§Ã£o...");
    return;
  }
  executando = true;
  
  const email = document.getElementById("email").value.trim();
  const senha = document.getElementById("senha").value.trim();
  const msg = document.getElementById("msg");

  if (!email || !senha) {
    mostrarStatus(msg, "âŒ Digite email e senha", "erro");
    executando = false;
    return;
  }

  mostrarStatus(msg, "ğŸŸ¡ Verificando login...", "processando");
  console.log("ğŸ”‘ Iniciando login...");

  try {
    const res = await fetch(`${API}/bonecos`);
    const dados = await res.json();
    const p = dados.find(x => x.email === email && x.senha === senha);

    if (!p) {
      mostrarStatus(msg, "âŒ Login invÃ¡lido", "erro");
      console.log("âŒ Login falhou");
      return;
    }

    passageiro = p;
    mostrarStatus(msg, `âœ… Logado: ${p.nome}`, "sucesso");
    console.log("âœ… Login OK:", p.nome);
    
    // Busca corrida apÃ³s login
    buscarCorrida();
    
  } catch (e) {
    mostrarStatus(msg, "âŒ Erro de conexÃ£o", "erro");
    console.error("âŒ Erro login:", e);
  } finally {
    executando = false;
  }
}

// ---- FUNÃ‡ÃƒO 2: BUSCAR CORRIDA ----
async function buscarCorrida() {
  if (executando) {
    console.log("â³ Busca jÃ¡ em execuÃ§Ã£o...");
    return;
  }
  executando = true;
  
  const msg = document.getElementById("msg");
  mostrarStatus(msg, "ğŸŸ¡ Buscando sua corrida...", "processando");
  console.log("ğŸ” Buscando corrida para passageiro:", passageiro.id);

  try {
    // Busca Ãºltima corrida do passageiro
    const res = await fetch(`${API}/corridas/passageiro/${passageiro.id}`);
    const corridas = await res.json();
    
    if (corridas.length === 0) {
      mostrarStatus(msg, "âŒ Nenhuma corrida encontrada", "erro");
      console.log("âŒ Nenhuma corrida encontrada");
      return;
    }

    // Pega a Ãºltima corrida (mais recente)
    corridaAtual = corridas[0];
    console.log("âœ… Corrida encontrada:", corridaAtual);
    
    // Mostra seÃ§Ã£o da corrida
    document.getElementById("corridaSection").style.display = "block";
    mostrarStatus(msg, "âœ… Corrida carregada!", "sucesso");
    
    // Atualiza informaÃ§Ãµes
    atualizarInformacoes();
    
    // Carrega mapa
    carregarMapa();
    
    // Inicia verificaÃ§Ã£o automÃ¡tica
    iniciarVerificacaoAuto();
    
  } catch (e) {
    mostrarStatus(msg, "âŒ Erro ao buscar corrida", "erro");
    console.error("âŒ Erro buscar corrida:", e);
  } finally {
    executando = false;
  }
}

// ---- FUNÃ‡ÃƒO 3: ATUALIZAR INFORMAÃ‡Ã•ES ----
function atualizarInformacoes() {
  document.getElementById("infoValor").textContent = `R$ ${corridaAtual.valor}`;
  document.getElementById("infoOrigem").textContent = `${corridaAtual.origem_lat.toFixed(6)}, ${corridaAtual.origem_lng.toFixed(6)}`;
  document.getElementById("infoDestino").textContent = `${corridaAtual.destino_lat.toFixed(6)}, ${corridaAtual.destino_lng.toFixed(6)}`;
  document.getElementById("infoStatus").textContent = traduzirStatus(corridaAtual.status);
  document.getElementById("infoMotorista").textContent = corridaAtual.motorista_nome || "Aguardando motorista...";
  
  // Mensagens especiais
  if (corridaAtual.motorista_nome) {
    mostrarMensagemMotorista();
  }
}

// ---- FUNÃ‡ÃƒO 4: CARREGAR MAPA ----
function carregarMapa() {
  // Remove mapa anterior se existir
  if (mapa) {
    mapa.remove();
  }
  
  // Cria novo mapa centralizado na origem
  mapa = L.map('map').setView([corridaAtual.origem_lat, corridaAtual.origem_lng], 13);
  
  // Adiciona tiles do OpenStreetMap
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap'
  }).addTo(mapa);
  
  // Adiciona marcadores
  const origemMarker = L.marker([corridaAtual.origem_lat, corridaAtual.origem_lng])
    .addTo(mapa)
    .bindPopup("ğŸ“ Sua LocalizaÃ§Ã£o")
    .openPopup();
    
  const destinoMarker = L.marker([corridaAtual.destino_lat, corridaAtual.destino_lng])
    .addTo(mapa)
    .bindPopup("ğŸ¯ Destino");
  
  // Adiciona rota (se Routing Machine carregou)
  if (L.Routing) {
    L.Routing.control({
      waypoints: [
        L.latLng(corridaAtual.origem_lat, corridaAtual.origem_lng),
        L.latLng(corridaAtual.destino_lat, corridaAtual.destino_lng)
      ],
      routeWhileDragging: false,
      showAlternatives: false,
      lineOptions: {
        styles: [{color: 'blue', opacity: 0.6, weight: 4}]
      }
    }).addTo(mapa);
  }
  
  // Ajusta zoom para mostrar ambos os pontos
  const group = new L.featureGroup([origemMarker, destinoMarker]);
  mapa.fitBounds(group.getBounds().pad(0.1));
  
  console.log("ğŸ—ºï¸ Mapa carregado com origem e destino");
}

// ---- FUNÃ‡ÃƒO 5: VERIFICAR ATUALIZAÃ‡Ã•ES ----
async function verificarCorrida() {
  if (executando) {
    console.log("â³ VerificaÃ§Ã£o jÃ¡ em execuÃ§Ã£o...");
    return;
  }
  executando = true;
  
  const statusAtualizar = document.getElementById("statusAtualizar");
  mostrarStatus(statusAtualizar, "ğŸŸ¡ Verificando atualizaÃ§Ãµes...", "processando");
  console.log("ğŸ”„ Verificando atualizaÃ§Ãµes da corrida...");

  try {
    const res = await fetch(`${API}/corridas/passageiro/${passageiro.id}`);
    const corridas = await res.json();
    
    if (corridas.length === 0) {
      mostrarStatus(statusAtualizar, "âŒ Corrida nÃ£o encontrada", "erro");
      return;
    }

    const novaCorrida = corridas[0];
    
    // Verifica se houve mudanÃ§as
    if (JSON.stringify(novaCorrida) !== JSON.stringify(corridaAtual)) {
      corridaAtual = novaCorrida;
      atualizarInformacoes();
      mostrarStatus(statusAtualizar, "âœ… Status atualizado!", "sucesso");
      console.log("ğŸ”„ Corrida atualizada:", novaCorrida);
    } else {
      mostrarStatus(statusAtualizar, "âœ… Nenhuma alteraÃ§Ã£o", "sucesso");
    }
    
  } catch (e) {
    mostrarStatus(statusAtualizar, "âŒ Erro ao verificar", "erro");
    console.error("âŒ Erro verificar:", e);
  } finally {
    executando = false;
  }
}

// ---- FUNÃ‡ÃƒO 6: VERIFICAÃ‡ÃƒO AUTOMÃTICA ----
function iniciarVerificacaoAuto() {
  // Para timer anterior se existir
  if (timerAtualizacao) {
    clearInterval(timerAtualizacao);
  }
  
  // Verifica a cada 5 segundos
  timerAtualizacao = setInterval(() => {
    if (!executando) {
      verificarCorrida();
    }
  }, 5000);
  
  console.log("â° VerificaÃ§Ã£o automÃ¡tica iniciada (5s)");
}

// ---- FUNÃ‡ÃƒO 7: MOSTRAR MENSAGEM MOTORISTA ----
function mostrarMensagemMotorista() {
  const msg = document.getElementById("msg");
  mostrarStatus(msg, `ğŸš— Motorista ${corridaAtual.motorista_nome} vem te buscar!`, "sucesso");
  
  // Alerta visual
  setTimeout(() => {
    alert(`ğŸš— ATENÃ‡ÃƒO! Motorista ${corridaAtual.motorista_nome} estÃ¡ a caminho!`);
  }, 1000);
}

// ---- FUNÃ‡Ã•ES AUXILIARES ----
function traduzirStatus(status) {
  const statusMap = {
    'solicitada': 'ğŸŸ¡ Aguardando motorista',
    'andamento': 'â¡ï¸ Viagem em andamento', 
    'concluida': 'âœ… Corrida finalizada',
    'cancelada': 'âŒ Corrida cancelada'
  };
  return statusMap[status] || status;
}

function mostrarStatus(elemento, mensagem, tipo) {
  elemento.innerHTML = mensagem;
  elemento.className = `status ${tipo}`;
}

// ---- LIMPEZA AO SAIR ----
window.addEventListener('beforeunload', () => {
  if (timerAtualizacao) {
    clearInterval(timerAtualizacao);
  }
});
</script>
</body>
</html>
